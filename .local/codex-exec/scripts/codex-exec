#!/usr/bin/env python3
import json
import subprocess
import sys


def write_stderr(line: str = "") -> None:
    sys.stderr.write(f"{line}\n")
    sys.stderr.flush()


def main() -> int:
    args = [arg for arg in sys.argv[1:] if arg not in ("--json", "--experimental-json")]
    cmd = ["codex", "exec", "--json", *args]
    proc = subprocess.Popen(
        cmd,
        stdin=None,
        stdout=subprocess.PIPE,
        stderr=subprocess.DEVNULL,
        text=True,
        bufsize=1,
    )

    session_id = None
    last_message = None
    final_printed = False

    if proc.stdout is None:
        return 1

    for raw_line in proc.stdout:
        line = raw_line.strip()
        if not line:
            continue
        try:
            event = json.loads(line)
        except json.JSONDecodeError:
            continue

        event_type = event.get("type")
        if event_type == "thread.started":
            session_id = event.get("thread_id", session_id)
            continue

        if event_type == "turn.completed":
            if last_message and not final_printed:
                if last_message.endswith("\n"):
                    sys.stdout.write(last_message)
                else:
                    sys.stdout.write(f"{last_message}\n")
                sys.stdout.flush()
                final_printed = True
            continue

        if event_type == "turn.failed":
            error = event.get("error", {}).get("message", "")
            if error:
                write_stderr(f"ERROR: {error}")
            continue

        if event_type == "error":
            message = event.get("message", "")
            if message:
                write_stderr(f"ERROR: {message}")
            continue

        if event_type == "item.completed":
            item = event.get("item", {})
            item_type = item.get("type")
            if item_type == "agent_message":
                message = item.get("text", "")
                if message:
                    last_message = message
            elif item_type == "error":
                message = item.get("message", "")
                if message:
                    write_stderr(f"warning: {message}")

    proc.wait()

    if last_message and not final_printed:
        if last_message.endswith("\n"):
            sys.stdout.write(last_message)
        else:
            sys.stdout.write(f"{last_message}\n")
        sys.stdout.flush()

    if session_id:
        write_stderr(f"session id: {session_id}")

    return proc.returncode


if __name__ == "__main__":
    sys.exit(main())
